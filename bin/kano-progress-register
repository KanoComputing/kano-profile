#!/usr/bin/env python

# kano-progression-register
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# Argument 1: Project or Scan
# If Project name send Google Form or create temp file
# If Scan: scan for temp files and send Google Forms
#

import requests
import time
import os
import sys
if __name__ == '__main__' and __package__ is None:
    dir_path = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
    if dir_path != '/usr':
        sys.path.insert(1, dir_path)

from kano.network import is_internet
from kano.utils import get_user, delete_file, get_cpu_id

USER = get_user()


def scan():
    # Video
    video_file = "/home/" + USER + "/.project_video"
    if os.path.exists(video_file):
        send_form('video')
        delete_file(video_file)
    # Snake
    snake_file = "/home/" + USER + "/.project_snake"
    if os.path.exists(snake_file):
        send_form('snake')
        delete_file(snake_file)
    # Pong
    pong_file = "/home/" + USER + "/.project_pong"
    if os.path.exists(pong_file):
        send_form('pong')
        delete_file(pong_file)
    # Minecraft
    mc_file = "/home/" + USER + "/.project_minecraft"
    if os.path.exists(mc_file):
        send_form('minecraft')
        delete_file(mc_file)


def send_form(project):
    # Details of the Google form
    url = "https://docs.google.com/a/kano.me/forms/d/15tfyqx2J0XFjf1rytguy8cFEZ3E20HZ3iU5wVZalyAk/formResponse"
    # User email
    email = ''
    entryEmail = "entry.1049053909"
    # User name
    entryName = "entry.1615253867"
    # RPi ID
    entryId = "entry.842182050"
    cpu_id = get_cpu_id()
    # Project
    entryProject = "entry.1067737306"

    info = {entryEmail: email, entryName: USER, entryId: cpu_id, entryProject: project}

    # Create a post request with the information gathered
    numTries = 3
    while numTries > 0:
        try:
            r = requests.post(url, data=info)
        except requests.ConnectionError:
            return 1
        if r.status_code == 200:
            break
        numTries -= 1
        time.sleep(1)
    return 0


if __name__ == '__main__':
    # Check for the correct number of parameters
    if len(sys.argv) != 2:
        print "Error: incorrect parameters [Project/Scan]"
        sys.exit(1)

    # Check mode (project os scan)
    if sys.argv[1].lower() == 'scan':
        # Check for internet
        if is_internet():
            scan()

    else:
        # If not internet then create a file to send later
        if not is_internet():
            tmp_file = "/home/" + USER + "/.project_" + sys.argv[1]
            if not os.path.exists(tmp_file):
                open(tmp_file, 'w').close()

        # Send form with project passed through argument
        else:
            r = send_form(sys.argv[1])
            # Check for unsend projects since we have internet
            if r == 0:
                scan()

    sys.exit(0)
