#!/usr/bin/env python

# kano-login
#
# Copyright (C) 2014-2015 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU GPL v2
#


"""
kano-login shows the different screens for logging in and registering.

Usage:
  kano-login [-r]
  kano-login <screen>

Options:
   -h, --help       Show this message.
   -r, --register
"""


import os
import sys
import docopt

from gi.repository import Gtk, GObject

if __name__ == '__main__' and __package__ is None:
    dir_path = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
    if dir_path != '/usr':
        sys.path.insert(1, dir_path)

from kano.gtk3.application_window import ApplicationWindow
from kano.gtk3.apply_styles import apply_styling_to_screen
from kano.gtk3.cursor import attach_cursor_events
from kano_profile_gui.paths import media_dir
from kano_avatar_gui.CharacterCreator import CharacterCreator
from kano_registration_gui.PageControl import PageControl
from kano_login.first_screen import FirstScreen
import kano_profile_gui.components.icons as icons
from kano_login.login import Login
from kano.gtk3.kano_dialog import KanoDialog

try:
    from kano_profile.tracker import Tracker
    kanotracker = Tracker()
except:
    pass

GObject.threads_init()


class MainWindow(ApplicationWindow):
    height = 300
    width = 300

    def __init__(self, screen="login"):
        ApplicationWindow.__init__(self,
                                   'Kano-Login',
                                   self.width,
                                   self.height)

        self.connect("delete-event", Gtk.main_quit)
        self.set_position(Gtk.WindowPosition.CENTER_ALWAYS)

        # This is what we fill up as we get data
        self.data = {}

        header_bar = HeaderBar()
        self.set_decorated(True)
        self.set_titlebar(header_bar)
        self.set_icon_name("kano-world")

        css_path = os.path.join(media_dir, "CSS/register.css")
        apply_styling_to_screen(css_path)

        self.create_char_creator()

        if screen == "register":
            # Gives the user the option to log in or register
            FirstScreen(self)
        elif screen == "login":
            Login(self)

        self.show_all()

    def create_char_creator(self):
        # This is very very slow
        self.char_creator = CharacterCreator(randomise=True)

    def set_data(self, data_label, data):
        self._data[data_label] = data

    def create_page_control(self, selected_page, back_text, next_text):
        '''This returns a widget suitable for controlling the flow between
        screens
        '''
        page_control = PageControl(3, selected_page, back_text, next_text)
        page_control.set_margin_bottom(25)
        page_control.set_margin_top(25)

        return page_control


class HeaderBar(Gtk.Box):
    def __init__(self):
        Gtk.Box.__init__(self)

        self.back_button = Gtk.Button()
        back_icon = icons.get_ui_icon("dark_left_arrow")
        self.back_button.set_image(back_icon)
        # TODO: generalise the styling class a bit more to make this cless
        # confusing.
        self.back_button.get_style_context().add_class("close_button")
        attach_cursor_events(self.back_button)

        # TODO: Undecided about this now.
        # self.pack_start(self.back_button, False, False, 0)

        close_button = Gtk.Button()
        cross_icon = icons.get_ui_icon("cross")
        close_button.set_image(cross_icon)
        close_button.connect("clicked", self.close_window)
        close_button.get_style_context().add_class("close_button")
        attach_cursor_events(close_button)
        self.pack_end(close_button, False, False, 0)

    def close_window(self, widget=None):
        kd = KanoDialog(
            "Are you sure?",
            "You'll miss out on the best features of your Kano",
            [
                {
                    "label": "DON'T CLOSE",
                    "return_value": "dont-close",
                    "color": "green"
                },
                {
                    "label": "CLOSE",
                    "return_value": "close",
                    "color": "red"
                }
            ],
            parent_window=widget.get_toplevel()
        )

        response = kd.run()
        if response == "close":
            Gtk.main_quit()

    def hide_back(self):
        self.back_button.hide()


def main():
    args = docopt.docopt(__doc__)

    if args['--register'] or args['<screen>'] == '3':
        MainWindow("register")
    else:
        MainWindow('login')

    Gtk.main()
    return 0


if __name__ == '__main__':
    main()
