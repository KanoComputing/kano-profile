#!/usr/bin/env python

# kano-world-launcher
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# Launcher app for kano world
#

import os
import re
import errno
import sys
from urlparse import urlparse
from kano.webapp import WebApp
from kano.network import is_internet
from kano.utils import ensure_dir
from kano.world.functions import is_registered, get_token

app_name = 'kano-world-launcher'

try:
    from kano.profile.badges import increment_app_state_variable_with_dialog
    increment_app_state_variable_with_dialog('kano-profile', 'world_launcher_clicked', 1)
except Exception:
    pass


class Launcher(WebApp):
    def __init__(self):
        url = "http://world.kano.me"
        if is_registered:
            url = url + '/login/%s' % get_token()
        self._index = url
        self._title = "Kano World"

        self._decoration = True
        self._height = 768
        self._width = 900
        self._centered = True

    def _download(self, view, req, user=None):
        app = self._get_target_app(req)

        target_dir = None
        if app == "make-minecraft":
            target_dir = os.path.expanduser("~/Minecraft-content/webload")
        elif app == "make-pong":
            target_dir = os.path.expanduser("~/Pong-content/webload")
        else:
            return False

        ensure_dir(target_dir)
        filename = req.get_suggested_filename()
        req.set_destination_uri("file://{}/{}".format(target_dir, filename))
        req.connect("notify::status", self._download_status_change)

        return True

    def _get_target_app(self, req):
        uri = req.get_uri()
        o = urlparse(uri)

        param_re = re.search("app=([a-zA-Z0-9\-]+)", o.query)
        if param_re != None:
            return param_re.group(1)

        return None

    def _download_progress(self, req, progress):
        if progress == 100:
            print "Download finished!"

    def _download_status_change(self, req, status):
        if req.get_status().value_name == 'WEBKIT_DOWNLOAD_STATUS_ERROR':
            os.system("zenity --error --text 'Download failed!'")
        elif req.get_status().value_name == 'WEBKIT_DOWNLOAD_STATUS_FINISHED':
            os.system("zenity --info --text 'Download completed.'")

# Check internet status
if not is_internet():
    os.system('sudo /usr/bin/kano-settings 4')
    sys.exit()

launcher = Launcher()
launcher.run()
