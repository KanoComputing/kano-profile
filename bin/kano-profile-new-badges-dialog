#!/usr/bin/env python

# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#

from gi.repository import Gtk

import os
import sys
if __name__ == '__main__' and __package__ is None:
    dir_path = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
    if dir_path != '/usr':
        sys.path.insert(1, dir_path)

from kano.utils import is_gui
from kano_profile_gui.images import get_image

img_width = 50


class MainWindow(Gtk.Window):
    def __init__(self, newlevel, newbadges):
        if newlevel:
            title = 'Level Up!'
        elif newbadges:
            title = 'New Badges!'
        else:
            sys.exit('Nothing to display!')

        # Create main window
        Gtk.Window.__init__(self, title=title)
        self.set_size_request(300, 200)

        # Create common elements
        # Main table
        table = Gtk.Table(2, 1, False)
        self.add(table)

        if newlevel:
            msg = "Congratulations, you've leveled up to level {}!".format(newlevel)
            label = Gtk.Label()
            label.set_text(msg)
            table.attach(label, 0, 1, 0, 1)

        elif newbadges:
            print newbadges
            icon_table = Gtk.Table(len(newbadges), 2, False)
            for i, item_str in enumerate(newbadges):
                group, item = item_str.split(':')
                img_path = get_image(item, group, img_width)
                img = Gtk.Image()
                img.set_from_file(img_path)
                icon_table.attach(img, i, i + 1, 0, 1)

                label = Gtk.Label()
                label.set_text('{} {}'.format(group, item))
                icon_table.attach(label, i, i + 1, 1, 2)
            table.attach(icon_table, 0, 1, 0, 1)

        # OK Button
        button = Gtk.Button(label='OK', halign=Gtk.Align.CENTER)
        button.connect('clicked', Gtk.main_quit)
        table.attach(button, 0, 1, 1, 2)


def main(newlevel=None, newbadges=None):
    if len(sys.argv) == 1:
        sys.exit('Wrong usage')

    if sys.argv[1] == 'newlevel':
        newlevel = int(sys.argv[2])
    elif sys.argv[1] == 'newbadges':
        newbadges = sys.argv[2:]

    if not is_gui():
        sys.exit('Needs GUI to run!')

    win = MainWindow(newlevel, newbadges)
    win.connect('delete-event', Gtk.main_quit)
    win.show_all()
    Gtk.main()


if __name__ == '__main__':
    main()
