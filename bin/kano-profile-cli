#!/usr/bin/env python

# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#

import os
import sys
if __name__ == '__main__' and __package__ is None:
    dir_path = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
    if dir_path != '/usr':
        sys.path.insert(1, dir_path)

from kano.profile.apps import get_app_data_dir, load_app_state_variable
from kano.profile.profile import set_unlocked, load_profile, get_avatar, get_environment
from kano.profile.badges import save_app_state_variable_with_dialog, calculate_xp, \
    calculate_kano_level, increment_app_state_variable_with_dialog
from kano.world.functions import is_registered, get_mixed_username, has_token
from kano.utils import is_number

variable_not_found_str = "VARIABLE_NOT_FOUND"


def check_arg_len(number):
    if len(sys.argv) != number + 1:
        print 'Command entered was {}'.format(sys.argv)
        sys.exit("Wrong usage, need {} arguments".format(number))


if __name__ != '__main__':
    sys.exit("This is a script, do not import it as a module!")

if len(sys.argv) == 1:
    help = 'Wrong usage, needs an argument\n'
    help += 'Possible uses: get_app_data_dir, load_app_state_variable, save_app_state_variable\n'
    help += 'increment_app_state_variable, unlock, lock, is_registered, get_avatar, get_xp\n'
    help += 'get_level, get_username, has_token, get_stats'
    sys.exit(help)

if sys.argv[1] == 'get_app_data_dir':
    check_arg_len(2)
    app_name = sys.argv[2]
    sys.stdout.write(get_app_data_dir(app_name))

elif sys.argv[1] == 'load_app_state_variable':
    check_arg_len(3)
    app_name = sys.argv[2]
    variable = sys.argv[3]
    value = load_app_state_variable(app_name, variable)
    if value:
        sys.stdout.write(str(value))
    else:
        sys.stdout.write(variable_not_found_str)

elif sys.argv[1] == 'save_app_state_variable':
    check_arg_len(4)
    app_name = sys.argv[2]
    variable = sys.argv[3]
    value = sys.argv[4]
    if value.isdigit():
        value = int(value)
    elif is_number(value):
        value = float(value)
    save_app_state_variable_with_dialog(app_name, variable, value)

elif sys.argv[1] == 'increment_app_state_variable':
    check_arg_len(4)
    app_name = sys.argv[2]
    variable = sys.argv[3]
    value = sys.argv[4]
    if value.isdigit():
        value = int(value)
    elif is_number(value):
        value = float(value)
    increment_app_state_variable_with_dialog(app_name, variable, value)

elif sys.argv[1] == 'unlock':
    check_arg_len(1)
    set_unlocked(True)

elif sys.argv[1] == 'lock':
    check_arg_len(1)
    set_unlocked(False)

elif sys.argv[1] == 'has_token':
    check_arg_len(1)
    print int(has_token())
    sys.exit(int(has_token()))

elif sys.argv[1] == 'get_stats':
    check_arg_len(1)

    print 'mixed_username: {}'.format(get_mixed_username())

    print 'is_registered: {}'.format(int(is_registered()))
    print 'has_token: {}'.format(int(has_token()))

    print 'xp: {}'.format(calculate_xp())

    level, progress = calculate_kano_level()
    progress = int(progress * 100)
    print 'level: {}'.format(level)
    print 'progress: {}'.format(progress)

    avatar_cat, avatar_item = get_avatar()
    environment = get_environment()
    print 'avatar: {} {}'.format(avatar_cat, avatar_item)
    print 'environment: {}'.format(environment)

    avatar_image_path = os.path.join('/usr/share/kano-profile/media/images/avatars/54x54/',
                                     avatar_cat, '{}_circular.png'.format(avatar_item))
    if not os.path.exists(avatar_image_path):
        avatar_image_path = 'image_missing'
    print 'avatar_image_path: {}'.format(avatar_image_path)

    progress_value = max(1, progress / 5)
    progress_image_path = os.path.join('/usr/share/kano-profile/media/images/progress_icons/90x90/',
                                       '{}.png'.format(progress_value))
    if not os.path.exists(progress_image_path):
        progress_image_path = 'image_missing'
    print 'progress_image_path: {}'.format(progress_image_path)

elif sys.argv[1] == 'get_email':
    check_arg_len(1)
    try:
        email = load_profile()['email']
        print email
    except Exception:
        print 'Email not found'
        sys.exit(1)

else:
    sys.exit("wrong usage")
